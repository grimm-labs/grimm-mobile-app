# ğŸ”— Links:
# Source file: https://github.com/obytes/react-native-template-obytes/blob/master/.github/actions/eas-build/action.yml
# EAS Build docs: https://docs.expo.dev/eas-update/github-actions/

# âœï¸ Description:
# This is a composite action, which means it can be used in other actions.
# This action is used to trigger an EAS Build for a specific environment (development, staging, production).
# This action accepts those inputs:
#        `APP_ENV`, which is used to generate an APK for a specific environment (development, staging, production). We use staging by default.
#        `AUTO_SUBMIT_ANDROID`, false by default, set to true if you want to automatically submit your Android build to store.
#        `AUTO_SUBMIT_IOS`, false by default, set to true if you want to automatically submit your iOS build to store.
#        `EXPO_TOKEN`, required, access token for your Expo account. https://expo.dev/settings/access-tokens
#        `GOOGLE_SERVICES_KEY_BASE64`, required for Android submission, base64 encoded service account key.
#        `VERSION`, required, version of the app to build. used as the build message.
#        `ANDROID`, true by default, set to true if you don't want to trigger build for Android.
#        `IOS`, false by default, set to true if you  want to trigger build for IOS.

# Before triggering the build, we run a pre-build script to generate the necessary native folders based on the APP_ENV.
# Based on the ANDROID and IOS inputs, we trigger the build for the corresponding platform with the corresponding flags.

# ğŸ‘€ Example usage:
#      - name: â±ï¸ EAS Build
#        uses: ./.github/actions/eas-build
#        with:
#          APP_ENV: staging
#          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
#          GOOGLE_SERVICES_KEY_BASE64: ${{ secrets.GOOGLE_SERVICES_API_KEY_BASE64 }}
#          VERSION: ${{ github.event.release.tag_name }}
#          ANDROID: true
#          IOS: false
#          AUTO_SUBMIT_ANDROID: true
#          AUTO_SUBMIT_IOS: false

name: 'Setup EAS Build + Trigger Build'
description: 'Setup EAS Build + Trigger Build'
inputs:
  APP_ENV:
    description: 'APP_ENV (one of): development, staging, production'
    required: true
    default: 'staging'
  AUTO_SUBMIT_ANDROID:
    description: 'AUTO_SUBMIT_ANDROID (one of): true, false'
    required: true
    default: 'false'
  AUTO_SUBMIT_IOS:
    description: 'AUTO_SUBMIT_IOS (one of): true, false'
    required: true
    default: 'false'
  ANDROID:
    description: 'run for ANDROID (one of): true, false'
    required: true
    default: 'true'
  VERSION:
    description: 'VERSION'
    required: true
    default: '0.0.0'
  IOS:
    description: 'run for IOS (one of): true, false'
    required: true
    default: 'false'
  EXPO_TOKEN:
    description: 'EXPO_TOKEN'
    required: true
  GOOGLE_SERVICES_KEY_BASE64:
    description: 'Base64 encoded Google Services API Key for Android submission'
    required: false

runs:
  using: 'composite'
  steps:
    - name: ğŸ’¯ Check for EXPO_TOKEN
      run: |
        if [ -z "${{ inputs.EXPO_TOKEN }}" ]; then
          echo "You must provide an EXPO_TOKEN secret linked to this project's Expo account in this repo's secrets. Learn more: https://docs.expo.dev/eas-update/github-actions"
          exit 1
        fi
      shell: bash

    - name: ğŸ“¦ Setup Expo and EAS
      uses: expo/expo-github-action@v8
      with:
        eas-version: latest
        token: ${{ inputs.EXPO_TOKEN }}

    - name: ğŸ” Setup Google Services Key for Android
      if: ${{ inputs.ANDROID == 'true' && inputs.GOOGLE_SERVICES_KEY_BASE64 != '' }}
      run: |
        mkdir -p ./credentials/android
        echo "${{ inputs.GOOGLE_SERVICES_KEY_BASE64 }}" | base64 -d > ./credentials/android/service-account.json
        echo "âœ… Google Services key file created"
      shell: bash

    - name: âš™ï¸ Run Prebuild
      run: pnpm prebuild:${{ inputs.APP_ENV }}
      shell: bash

    - name: ğŸ“± Run Android Build
      if: ${{ inputs.ANDROID == 'true' }}
      run: pnpm build:${{ inputs.APP_ENV }}:android ${{ inputs.AUTO_SUBMIT_ANDROID == 'true' && '--auto-submit' || '' }} --non-interactive --no-wait --message "Build ${{ inputs.APP_ENV }} ${{ inputs.VERSION }}"
      shell: bash

    - name: ğŸ“± Run IOS Build
      if: ${{ inputs.IOS == 'true' }}
      run: pnpm build:${{ inputs.APP_ENV }}:ios ${{ inputs.AUTO_SUBMIT_IOS == 'true' && '--auto-submit' || '' }} --non-interactive --clear-cache --no-wait --message "Build ${{ inputs.APP_ENV }} ${{ inputs.VERSION }}"
      shell: bash

    - name: ğŸ§¹ Clean up credentials
      if: always() && inputs.ANDROID == 'true' && inputs.GOOGLE_SERVICES_KEY_BASE64 != ''
      run: |
        rm -f ./credentials/android/service-account.json
        echo "âœ… Credentials cleaned up"
      shell: bash
